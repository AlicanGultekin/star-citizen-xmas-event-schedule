<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Star Citizen Events Calendar</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="d-flex justify-content-center">
      <ul id="events" class="list-group" style="list-style-type: none"></ul>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"
      integrity="sha512-bwD3VD/j6ypSSnyjuaURidZksoVx3L1RPvTkleC48SbHCZsemT3VKMD39KknPnH728LLXVMTisESIBOAb5/W0Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/plugin/utc.min.js"
      integrity="sha512-TU4ndEYOqql+pMXn14M8RDWsjjD+VPUA2RoWSuuFd+blPJW4oLrL1w1zAGdlrk4jsE2FEBH5CU3+fmogVYEqIQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/plugin/timezone.min.js"
      integrity="sha512-72V2JNSAxd3rsQIpDSAbCTQXD6gi91Cd/IFZ6NYwRjZSiIlIJfDrJLXq+UomWstOg+zGHWFfkTDl3APEUMoqlw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/plugin/relativeTime.min.js"
      integrity="sha512-7YYTlJ8OTdmDMztOy8q+zfRI/+y/IWnVp1oS4kiTKa+X2P09k/ObWUemEjtMoumu8v4A0s1NZu7WjfR+UxhRCQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      dayjs.extend(window.dayjs_plugin_utc);
      dayjs.extend(window.dayjs_plugin_timezone);
      dayjs.extend(window.dayjs_plugin_relativeTime, {
        thresholds: [
          { l: "s", r: 1 },
          { l: "m", r: 1 },
          { l: "mm", r: 59, d: "minute" },
          { l: "h", r: 1 },
          { l: "hh", r: 23, d: "hour" },
          { l: "d", r: 1 },
          { l: "dd", r: 29, d: "day" },
          { l: "M", r: 1 },
          { l: "MM", r: 11, d: "month" },
          { l: "y" },
          { l: "yy", d: "year" },
        ],
        rounding: Math.floor,
      });

      const userTimezone = dayjs.tz.guess();
      const eventsList = document.getElementById("events");
      let now = dayjs();

      let events = [
        {
          name: "Jumptown 2.0",
          text: "February 19 - 05:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 19 Feb 2022 05:00:00 GMT",
          end: "Sat, 19 Feb 2022 21:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 19 - 21:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 19 Feb 2022 21:00:00 GMT",
          end: "Sun, 20 Feb 2022 13:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 20 - 13:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sun, 20 Feb 2022 13:00:00 GMT",
          end: "Mon, 21 Feb 2022 05:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 22 - 00:00 UTC (Duration: 24hr)",
          timezone: "UTC",
          duration: "24",
          start: "Tue, 22 Feb 2022 00:00:00 GMT",
          end: "Wed, 23 Feb 2022 00:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 24 - 01:00 UTC (Duration: 24hr)",
          timezone: "UTC",
          duration: "24",
          start: "Thu, 24 Feb 2022 01:00:00 GMT",
          end: "Fri, 25 Feb 2022 01:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 26 - 05:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 26 Feb 2022 05:00:00 GMT",
          end: "Sat, 26 Feb 2022 21:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 26 - 21:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 26 Feb 2022 21:00:00 GMT",
          end: "Sun, 27 Feb 2022 13:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "February 27 - 13:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sun, 27 Feb 2022 13:00:00 GMT",
          end: "Mon, 28 Feb 2022 05:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "March 1 - 02:00 UTC (Duration: 24hr)",
          timezone: "UTC",
          duration: "24",
          start: "Tue, 01 Mar 2022 02:00:00 GMT",
          end: "Wed, 02 Mar 2022 02:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "March 3 - 00:00 UTC (Duration: 24hr)",
          timezone: "UTC",
          duration: "24",
          start: "Thu, 03 Mar 2022 00:00:00 GMT",
          end: "Fri, 04 Mar 2022 00:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "March 5 - 05:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 05 Mar 2022 05:00:00 GMT",
          end: "Sat, 05 Mar 2022 21:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "March 5 - 21:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sat, 05 Mar 2022 21:00:00 GMT",
          end: "Sun, 06 Mar 2022 13:00:00 GMT",
        },
        {
          name: "Jumptown 2.0",
          text: "March 6 - 13:00 UTC (Duration: 16hr)",
          timezone: "UTC",
          duration: "16",
          start: "Sun, 06 Mar 2022 13:00:00 GMT",
          end: "Mon, 07 Mar 2022 05:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 21 - 06:00 UTC",
          timezone: "UTC",
          start: "Mon, 21 Feb 2022 06:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 21 - 16:00 UTC",
          timezone: "UTC",
          start: "Mon, 21 Feb 2022 16:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 23 - 08:00 UTC",
          timezone: "UTC",
          start: "Wed, 23 Feb 2022 08:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 23 - 20:00 UTC",
          timezone: "UTC",
          start: "Wed, 23 Feb 2022 20:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 25 - 04:00 UTC",
          timezone: "UTC",
          start: "Fri, 25 Feb 2022 04:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 25 - 16:00 UTC",
          timezone: "UTC",
          start: "Fri, 25 Feb 2022 16:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 28 - 06:00 UTC",
          timezone: "UTC",
          start: "Mon, 28 Feb 2022 06:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "February 28 - 16:00 UTC",
          timezone: "UTC",
          start: "Mon, 28 Feb 2022 16:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "March 2 - 04:00 UTC",
          timezone: "UTC",
          start: "Wed, 02 Mar 2022 04:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "March 2 - 16:00 UTC",
          timezone: "UTC",
          start: "Wed, 02 Mar 2022 16:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "March 4 - 08:00 UTC",
          timezone: "UTC",
          start: "Fri, 04 Mar 2022 08:00:00 GMT",
        },
        {
          name: "Nine Tails Lockdown",
          text: "March 4 - 20:00 UTC",
          timezone: "UTC",
          start: "Fri, 04 Mar 2022 20:00:00 GMT",
        },
      ];

      function filterAndSortEvents() {
        events = events
          .filter((event) => {
            if (event.end) {
              return now.diff(dayjs(event.end)) <= 60 * 1000; // display a finished event for one minute
            }
            return now.diff(dayjs(event.start)) <= 5 * 60 * 60 * 1000; // if event doesn't have an end time, still show the ones that started 5 hours ago
          })
          .sort((a, b) => dayjs(a.start) - dayjs(b.start));
      }

      function addEvent(eventData) {
        now = dayjs();
        const duration = eventData.duration
          ? `<span class="badge bg-primary rounded-pill">Duration: ${eventData.duration} hours</span>`
          : "";

        const end = eventData.end
          ? `<h1 class="display-6"><strong>End</strong>: ${dayjs(eventData.end)
              .tz(userTimezone, true)
              .local()
              .toDate()
              .toLocaleString()}</h1>`
          : "";

        const startDiff = now.diff(dayjs(eventData.start));
        const endDiff = now.diff(dayjs(eventData.end));
        const isActive = startDiff > 0 && endDiff <= 0;

        const relativeStartTime = `<span class="badge bg-info rounded-pill">${
          isActive ? "Started" : "Starts"
        } ${dayjs().to(dayjs(eventData.start))}</span>`;

        const disclaimer = "";
        // TODO: Have disclaimers in event data per event
        // const disclaimer = !eventData.name
        //   ? `</br></br>This event starts 1-2 hours after the noted start time, follow the ingame voice lines and look for the blockade on your map.`
        //   : "</br></br>Production stops in the last hour of this event, you can still sell, but cannot get more boxes.";

        const relativeEndTime =
          eventData.end && isActive
            ? `<span class="badge bg-danger rounded-pill">Ends ${dayjs().to(
                dayjs(eventData.end)
              )}</span>`
            : "";

        const activity = eventData.end
          ? isActive
            ? `<span class="badge bg-success rounded-pill">Active</span>`
            : `<span class="badge bg-secondary rounded-pill">Finished</span>`
          : "";

        const eventHtml = `
              <li class="list-group-item justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <h1 class="display-3">${eventData.name}</h1>
                  <h1 class="display-6"><strong>Start</strong>: ${dayjs(
                    eventData.start
                  )
                    .tz(userTimezone, true)
                    .local()
                    .toDate()
                    .toLocaleString()}</h1>
                  ${end}
                </div>
                ${startDiff >= 0 ? activity : ""}
                ${relativeStartTime}
                ${duration}
                ${relativeEndTime}
                ${disclaimer}
              </li>
            `;

        const li = document.createElement("li");
        li.innerHTML = eventHtml;
        eventsList.appendChild(li);
      }

      function generateHtmlForAllEvents() {
        events.forEach((event) => {
          addEvent(event);
        });
      }

      function clearEvents() {
        eventsList.innerHTML = "";
      }

      function showEventsEndedMessaging() {
        clearEvents();
        const h1 = document.createElement("h1");
        h1.innerHTML = `<p class="text-center">The events have ended for now.</p>`;
        eventsList.appendChild(h1);
      }

      filterAndSortEvents();

      if (events.length > 0) {
        generateHtmlForAllEvents();

        let refreshEventsTimer;
        refreshEventsTimer = setInterval(() => {
          if (events.length > 0) {
            filterAndSortEvents();
            clearEvents();
            generateHtmlForAllEvents();
          } else {
            if (refreshEventsTimer) clearInterval(refreshEventsTimer);
            showEventsEndedMessaging();
          }
        }, 60 * 1000); // re-render events every minute
      } else {
        showEventsEndedMessaging();
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
      integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
